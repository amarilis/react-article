<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://unpkg.com/react@15.3.0/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.0/dist/react-dom.js"></script>
    <script src="https://unpkg.com/react-router/umd/ReactRouter.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.0/dist/jquery.min.js"></script>
	<!-- чтоб вставлялись теги в текст тегами, а не тем, что из них получится. -->
    <script src="https://unpkg.com/remarkable@1.7.1/dist/remarkable.min.js"></script>
    <script src="js/moment.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">
        var Router = ReactRouter.Router;
        var Route = ReactRouter.Route;
        var Link = ReactRouter.Link;
        var IndexLink = ReactRouter.IndexLink;
        var IndexRoute = ReactRouter.IndexRoute;
        var hashHistory = ReactRouter.browserHistory;


        var UserActive = React.createClass({
            render: function() {
                const USER_NUMBER = this.props.user;
                var user;
                if ( this.props.data.length > 0 ) {
                    user = <a className="articleUserLink" href={this.props.data[USER_NUMBER].email}>
                                <span>{this.props.data[USER_NUMBER].name.first}
                                &nbsp;
                                {this.props.data[USER_NUMBER].name.last}</span>
                                <img src={this.props.data[USER_NUMBER].picture} alt={this.props.data[USER_NUMBER].name.email}/>
                           </a>
                }



                return (
                        <div className="articleUser">
                          {user}
                        </div>
                );
            }
        });
        var SearchForm = React.createClass({
            filterArticle: function(e) {
                this.props.onFilterArticle(e.target.value);
            },
            render: function() {
                return (
                        <div className="searchForm">
                          <input
                                  className="searchFormInput"
                                  placeholder="Search article"
                                  onChange={this.filterArticle}
                          />
                        </div>
                );
            }
        });
        var Comment = React.createClass({
            render: function() {
                var articleEdit;
                if ( this.props.userActive == this.props.userId ) {
                    var editArticleHref = '/edit/' + this.props.articleId;
                    articleEdit = <div>
                                    <a className="articleEdit" href={editArticleHref}>Edit atricle</a>
                                  </div>
                }
                var registeredData =  moment().format('LLLL');

                var fullName = ( this.props.name != undefined ) ? <span>{this.props.name.first}&nbsp;{this.props.name.last}</span> : '';
                return (
                    <div className="article">

                      <div className="articleUser">
                        <span className="articleUserLink">
                          {fullName}
                          <img src={this.props.picture} alt={this.props.email}/>
                        </span>
                          {articleEdit}
                      </div>

                      <div className="articleContent">
                        <h2 className="articleTitle">{this.props.title}</h2>
                        <div className="articleRegistered">{registeredData}</div>
                        <div className="articleText">{this.props.article}</div>

                      </div>

                    </div>
                );
            }
        });

        var CommentBox = React.createClass({
            loadCommentsFromServer: function() {
                $.ajax({
                    url: this.props.url,
                    dataType: 'json',
                    cache: false,
                    success: function(data) {
                        this.setState({data: data, dataConst: data});
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.error(this.props.url, status, err.toString());
                    }.bind(this)
                });
            },
            handleCommentSubmit: function(comment) {
                var comments = this.state.data;
                // Optimistically set an id on the new comment. It will be replaced by an
                // id generated by the server. In a production application you would likely
                // not use Date.now() for this and would have a more robust system in place.
                comment.id = Date.now();
                var newComments = comments.concat([comment]);
                this.setState({data: newComments});
                $.ajax({
                    url: this.props.url,
                    dataType: 'json',
                    type: 'POST',
                    data: comment,
                    success: function(data) {
                        this.setState({data: data});
                    }.bind(this),
                    error: function(xhr, status, err) {
                        this.setState({data: comments});
                        console.error(this.props.url, status, err.toString());
                    }.bind(this)
                });
            },
            handleFilterArticle: function (searchQuery) {
                if ( searchQuery.length > 0) {
                    var filteredData = this.state.dataConst.filter(function(obj){
                      return obj.article.toLowerCase().search(searchQuery.toLowerCase())!== -1;
                  });
                  this.setState({data: filteredData});
                } else {
                    this.loadCommentsFromServer();
                }
            },
            getInitialState: function() {
                return {data: [],dataConst: [],user: ''};
            },
            componentDidMount: function() {
                this.loadCommentsFromServer();
                //setInterval(this.loadCommentsFromServer, this.props.pollInterval);
            },
            render: function() {
                return (
                        <div className="commentBox">
                            <header>
                                <UserActive data={this.state.dataConst} user={this.props.user}/>
                                <h1>Articles</h1>
                                <SearchForm onFilterArticle={this.handleFilterArticle}/>
                            </header>
                            <CommentList data={this.state.data} user={this.props.user}/>
                            <CommentForm onCommentSubmit={this.handleCommentSubmit}  data={this.state.dataConst} user={this.props.user}/>
                        </div>
                );
            }
        });

        var CommentList = React.createClass({
            render: function() {
                var userActive = this.props.user;
                var commentNodes = this.props.data.map(function(comment,index) {
                    return (
                        <Comment
                            articleId={comment.articleId}
                            userId={comment.userId}
                            isActive={comment.isActive}
                            picture={comment.picture}
                            name={comment.name}
                            email={comment.email}
                            title={comment.title}
                            article={comment.article}
                            registered={comment.registered}
                            key={index}
                            userActive={userActive}
                        ></Comment>
                    );
                });
                return (
                        <div className="commentList">
                            {commentNodes}
                        </div>
                );
            }
        });

        var CommentForm = React.createClass({
            getInitialState: function() {
                return {title: '', article: ''};
            },
            handleAuthorChange: function(e) {
                this.setState({title: e.target.value});
            },
            handleTextChange: function(e) {
                this.setState({article: e.target.value});
            },
            handleSubmit: function(e) {
                e.preventDefault();
                var title = this.state.title;
                var article = this.state.article;
                if (!article || !title) {
                    return;
                }
                var onCommentSubmitData = {
                    articleId: this.props.data.length,
                    userId: +this.props.user,
                    title: title,
                    article: article,
                    registered: Date.now(),
                    firstName: this.props.data[this.props.user].name.first,
                    lastName: this.props.data[this.props.user].name.last,
                    picture: this.props.data[this.props.user].picture,
                    email: this.props.data[this.props.user].email
                };
                this.props.onCommentSubmit(onCommentSubmitData);
                this.setState({title: '', article: ''});
            },
            render: function() {
                return (
                        <form className="commentForm" onSubmit={this.handleSubmit}>
                          <h2>Add article</h2>
                          <div><input
                                    type="text"
                                    placeholder="Title"
                                    value={this.state.title}
                                    onChange={this.handleAuthorChange}
                                    className="searchFormInput"
                            /></div>
                            <textarea
                                    type="text"
                                    placeholder="Article"
                                    value={this.state.article}
                                    onChange={this.handleTextChange}
                            />
                            <div className="sendButtonOut"><input type="submit" className="sendButton" value="Send" /></div>
                        </form>
                );
            }
        });

        ReactDOM.render(
                <CommentBox url="/comments" pollInterval={2000} user="0" />,
            document.getElementById('content')
        );
    </script>
  </body>
</html>
